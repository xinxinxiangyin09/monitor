# 监控平台部署手册-v1.0.2

```
# 新建文件夹
mkdir /data/code

# 传输压缩包，将压缩包上传至生产环境的/data下
scp chancey@192.168.1.100:12305 /root/monitor.tar.gz /data/

# 解压
tar xvf /data/monitor.tar.gz
```

## 一、YUM

本项目离线部署之前需要搭建本地的临时YUM仓库

1. 授权`rpms`文件夹

   ```bash
   chmod -R 755 /data/code/base/rpms
   ```

2. 创建YUM索引

   ```bash
   vim /etc/yum.repos.d/tmp.repo
   
   [centos]
   name=centos
   baseurl=file:///mirrors/centos7
   gpgcheck=0
   enable=1
   ```

3. 清空缓存

   ```bash
   yum clean all
   ```

4. 重载缓存

   ```bash
   yum makecache
   ```

## 二、PYTHON

在安装Python3之前，需要检查CentOS中有没有安装Python2的pip管理器

`pip list`


> 如果提示无此命令信息，则需要安装Python2的pip管理工具。
>
> 开发环境为CentOS7，自带PYTHON2.7，但是没有pip管理工具。

### 1. PIP

1. 下载pip：`wget https://bootstrap.pypa.io/pip/2.7/get-pip.py`

> 此处要是下载特别慢的话，请访问[蓝走云](https://wwrm.lanzoub.com/isHkS0nh5jpa)下载并上传至服务器。

> 离线安装的话，`get-pip.py`在`/data/code/base/package_for_py2/get-pip.py`

2. 安装pip：`python /data/code/base/pip_package_py2/get-pip.py pip==9.0.2 wheel==0.30.0 setuptools==28.8.0 --no-index --find-links=/data/code/env/package_for_py2/`

3. 更改pip加速地址为国内镜像（离线部署可不用配置，即使配置也无效）

```bash
# 编辑 ~/.pip/pip.conf 文件，没有则创建
[global]
timeout = 10
index-url =  https://mirrors.aliyun.com/pypi/simple/
extra-index-url= https://pypi.douban.com/simple/
[install]
trusted-host=
    mirrors.aliyun.com
    pypi.douban.com
```

4. 升级pip：`python -m pip install --upgrade setuptools --no-index --find-links=/data/file/env/package_for_py2`
5. 验证pip：`pip list`

### 2. PYTHON3

安装Python3之前需要安装编译环境和运行库。

1. 安装依赖库

    `yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel gcc`

2. 下载安装包（使用华为云下载速度更快）

    `wget https://mirrors.huaweicloud.com/python/3.6.5/Python-3.6.5.tgz`

3. 解压

    `tar -zxvf Python-3.6.2.tgz`

4. 切换到解压路径下编译安装

    `cd Python-3.6.2`

    `./configure prefix=/data/server/python`

    `make`

    `make install`

5. 添加软连接

    `ln -s /data/server/python/bin/python3 /usr/bin/python3`

6. 测试

    `python`

    `python3`

### 3. 配置虚拟环境

1. 安装依赖

    `pip install virtualenv --no-index --find-links=/data/file/env/package_for_py2`

    `pip install virtualenvwrapper --no-index --find-links=/data/file/env/package_for_py2`

> 注意：安装顺序不能乱，必须先安装virtualenv，然后安装virtualenvwrapper

2. 配置`virtualenvwrapper`

    ```bash
    # 打开.bashrc文件： vim ~/.bashrc ,在末尾新增如下内容
    export WORKON_HOME=$HOME/.virtualenvs 
    source /usr/bin/virtualenvwrapper.sh
    ```

    >  注意：这里的`virtualenvwrapper.sh`文件不一定在如上的目录，也可能在其他位置，使用`find`可找到具体位置。
    >
    >  `sudo find / -name virtualenvwrapper.sh`

3. 生效环境

    `source ~/.bashrc`

4. 创建虚拟环境

    `mkvirtualenv -p /data/server/python/python3 monitor`

    > 使用如上命令创建虚拟环境，会自动创建在用户目录下`.virtualenvs`
    >
    > 例如使用`admin`账户创建，则虚拟环境在`/home/admin/.virtualenvs/monitor`

2. 列出当前用户下的所有PYTHON虚拟环境

    `workon`

3. 使用虚拟环境

    进入：`workon py3env`

    退出：`deactivate`

4. 删除虚拟环境

    `rmvirtualenv py3env`

## 三、MYSQL

- 下载地址：https://repo.huaweicloud.com/mysql/Downloads/MySQL-8.0/mysql-8.0.29-linux-glibc2.12-x86_64.tar.xz
- 安装步骤

1. 下载源码包

   `wget https://repo.huaweicloud.com/mysql/Downloads/MySQL-8.0/mysql-8.0.29-linux-glibc2.12-x86_64.tar.xz`

2. 卸载`mariadb`

   ```bash
   # 查询已安装的包
   rpm -qa | grep mariadb
   
   # 卸载查询出来的所有包
   rpm -e mariadb-libs-5.5.68-1.el7.x86_64 --no-deps
   ```

3. 解压文件

   `tar -xvf mysql-8.0.29-linux-glibc2.12-x86_64.tar.xz`

4. 新建一个`mysql`文件夹

   `mkdir -p /data/server/mysql/data`

   `mkdir -p /data/server/mysql/log`

5. 将解压出来的文件全部移动到`/usr/local/mysql/`下

   `mv mysql-8.0.29-linux-glibc2.12-x86_64/* /usr/local/mysql/`

6. 创建`mysql`用户组和用户，并添加密码

   ```
   # 创建MySQL用户组
   groupadd mysql
   
   # 创建MySQL用户
   useradd mysql -g mysql
   
   # 为创建的用户添加密码
   passwd mysql
   ```

7. 备份之前的配置文件

   `mv /etc/my.cnf /etc/my.cnf.back`

8. 修改配置文件`/etc/my.cnf`

   ```
   # For advice on how to change settings please see
   # http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html
   # *** DO NOT EDIT THIS FILE. It's a template which will be copied to the
   # *** default location during install, and will be replaced if you
   # *** upgrade to a newer version of MySQL.
   
   [mysqld]
   
   # Remove leading # and set to the amount of RAM for the most important data
   # cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
   # innodb_buffer_pool_size = 128M
   
   # Remove leading # to turn on a very important data integrity option: logging
   # changes to the binary log between backups.
   # log_bin
   
   # These are commonly set, remove the # and set as required.
   basedir = /data/server/mysql
   datadir = /data/server/mysql/data
   port = 12306
   # server_id = .....
   socket = /tmp/mysql.sock
   character-set-server = utf8mb4
   collation_server = utf8mb4_general_ci
   skip-name-resolve
   log-error = /data/server/mysql/log/error.log
   pid-file = /data/server/mysql/mysql.pid
   lower_case_table_names=1
   
   # Remove leading # to set options mainly useful for reporting servers.
   # The server defaults are faster for transactions and fast SELECTs.
   # Adjust sizes as needed, experiment to find the optimal values.
   # join_buffer_size = 128M
   # sort_buffer_size = 2M
   # read_rnd_buffer_size = 2M 
   
   sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
   ```

   > 直接备份覆盖即可。
   >
   > 配置文件中注意几点：
   >
   > `character-set-server = utf8mb4`：表示mysql服务器级别默认的字符集编码，最好设置为utf8mb4；
   > `lower_case_table_names=1`：表示mysql中将表名一律转为小写；（其实取值有0、1或2，其中2是最理想的状态，但是这个配置在window、linux、macos下表现的不一致，所以还是取1吧，只不过取1后，所有的表名都强制小写了。）

9. 设定访问权限

   这里需要手动设定，MySQL包自己会用mysql用户启动进程，所以需要提前新增用户和用户组

   ```
   # 设置文件所属用户
   chown -R mysql /data/server/mysql/
   
   # 设置文件所属组
   chgrp -R mysql /data/server/mysql/
   ```

10. 初始化数据库

   ```bash
   /data/server/mysql/bin/mysqld --initialize --user=mysql --basedir=/data/server/mysql --datadir=/data/server/mysql/data --lower_case_table_names=1
   ```

11. 创建软连接

    ```
    ln -s /data/server/mysql/bin/mysql /usr/bin/mysql
    ```

12. 启动MySQL服务

    ```
    # 查询MySQL是否启动
    ps -ef | grep mysql
    ps -ef | grep mysqld
    
    # 启动服务
    /data/server/mysql/support-files/mysql.server start
    ```

13. 查看随机密码

    `grep 'password' /data/server/mysql/log/error.log`

    ![image-20230311211506531](https://s2.loli.net/2023/03/11/9xQ68UzgL1XPsiH.png)

14. 使用随机密码登录

    `/data/server/mysql/bin/mysql -u root -p`

15. 修改配置

    ```
    # 修改密码
    ALTER USER 'root'@'localhost' IDENTIFIED BY '0';
    
    # 授权远程访问
    UPDATE user SET host = "%" WHERE user = "root" AND host = "localhost";
    
    # 刷新权限
    FLUSH PRIVILEGES;
    ```

16. 重新启动服务

    `/data/server/mysql/support-files/mysql.server restart`

17. 服务启动制作

    ```
    # 制作systemctl启动
    vim /usr/lib/systemd/system/mysqld.service
    
    # 填入如下内容
    [Unit]
    Description=mysql
    After=network.target
    
    [Service]
    Type=forking
    PIDFile=/data/server/mysql/mysql.pid
    ExecStart=/data/server/mysql/support-files/mysql.server start
    ExecReload=/data/server/mysql/support-files/mysql.server restart
    ExecStop=/data/server/mysql/support-files/mysql.server stop
    PrivateTmp=true
    
    [Install]
    WantedBy=multi-user.target
    
    # 刷新系统的服务
    systemctl daemon-reload
    
    # 然后就可以用systemctl来启动服务了
    ```

    ![image-20230311212601625](https://s2.loli.net/2023/03/11/xgn9hP314DkV6Qm.png)

## 四、REDIS

1.下载安装包：

 `wget https://repo.huaweicloud.com/redis/redis-3.2.8.tar.gz `

2.解压：

` tar xzf redis-3.2.8.tar.gz `

3.进入目录,执行make编译：

` cd redis-3.2.8 `

` make `

> 注意：
>
> make命令执行完成编译后，会在src目录下生成6个可执行文件，分别是`redis-server`、`redis-cli`、`redis-benchmark`、`redis-check-aof`、`redis-check-rdb`、`redis-sentinel`。
>
> 新版本`redis-check-dump`改成`redis-check-rdb`

4.安装Redis：

` make install PREFIX=/data/server/redis`

会将make编译生成的6个可执行文件拷贝到`/usr/local/bin`目录下

5.配置redis：

` sh utils/install_server.sh `

> 启动脚本之前需要修改脚本内容，注释掉下边的内容，一般在第78行到83行
>
> ```
> _pid_1_exe="$(readlink -f /proc/1/exe)"
> if [ "${_pid_1_exe##*/}" = systemd ]
> then
>         echo "This systems seems to use systemd."
>         echo "Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!"
>         exit 1
> fi
> ```
>
> ```
> _pid_1_exe="$(readlink -f /proc/1/exe)"
> # if [ "${_pid_1_exe##*/}" = systemd ]
> # then
> #       echo "This systems seems to use systemd."
> #       echo "Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!"
> #       exit 1
> # fi
> ```
>
> 

Redis配置之后Redis能随系统启动执行期间会让等待用户选择端口，文件名称等，一般默认。

> - 开放`bind 0.0.0.0`
>
> - `protected-mode yes`改为`no`
> - `daemonize no`改为`yes`
> - `port`
> - `requirepass`设置密码
> - `logfile`设置日志位置

6.查看开机启动列表：

` chkconfig --list `

7.Redis服务查看、开启、关闭

查看Redis进程： `ps -ef|grep redis `

关闭Redis服务： `/etc/init.d/redis_6379 stop `

开启Redis服务： `/etc/init.d/redis_6379 start `

8.Redis测试：` redis-cli `

## 五、NGINX

1. 安装依赖

   ```bash
   yum install -y gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel
   ```

2. 下载源码包

   ```bash
   wget https://nginx.org/download/nginx-1.24.0.tar.gz
   ```

3. 解压

   ```bash
   tar -xvf nginx-1.24.0.tar.gz
   ```

4. 配置（HTTPS模块）

   ```bash
   ./configure --prefix=/data/server/nginx/ --with-http_stub_status_module --with-http_ssl_module
   ```

5. 编译安装

   ```bash
   make && make install
   ```

6. 创建软链接

   ```bash
   ln -s /data/server/nginx/sbin/nginx /usr/bin/nginx
   ```

7. 编辑服务文件

   `vim /lib/systemd/system/nginx.service`

   ```
   [Unit]
   Description=nginx service
   After=network.target
   
   [Service]
   Type=forking
   ExecStart=/data/server/nginx/sbin/nginx
   ExecReload=/data/server/nginx/sbin/nginx -s reload
   ExecStop=/data/server/nginx/sbin/nginx -s stop
   PrivateTmp=true
   
   [Install]
   WantedBy=multi-user.target
   ```

8. 启动

   ```bash
   systemctl start nginx
   ```

9. 配置HTTPS

   因为这里部署方式为`virtualenvwrapper`+`gunicorn`+`flask`（由`flask`发起网络应用，`gunicorn`做路由分发，然后代理到`nginx`上），仅支持Linux系统。若需要在Windows上部署，则改用`virtualenvwrapper`+`tornado`+`flask`部署（这里用`tornado`可以支持并发请求）

   因此，配置`FLASK`项目的`HTTPS`则只需要配置`nginx`即可支持SSL证书校验。

   配置如下：

   将`./base/server/nginx.conf`复制到`/data/server/nginx/conf`下

   将`./base/server/cert.pem`和`./base/server/cert.key`复制到`/data/server/nginx/conf`下

10. 重载nginx

    `/data/server/nginx/sbin/nginx -s reload`

## 六、PIP

```bash
cd /data/code/monitor

pip install --no-index --find-links=/data/code/monitor/pip_package -r /data/code/monitor/requirements.txt
```

> 下载pip包：`pip download -r requirements.txt -d packages/ -i https://pypi.tuna.tsinghua.edu.cn/simple`
>
> 打包：`pip freeze > requirements.txt`
>
> 离线安装：`pip install --no-index --find-links=./packages -r ./requirements.txt`

## 七、配置

### 1. 服务器配置

1. 关闭`selinux`

   ```
   # vim /etc/selinux/config
   SELINUX=disabled
   ```

2. 防火墙放行

   web访问需要放行防火墙，在主配置文件中的`web_port`配置，默认`5000`，且仅允许本地访问

   ```bash
   firewalld --add-port=5000/tcp --dermanent
   firewalld --reload
   ```

### 2. 项目配置

## 七、FLASK

`./root/virtualenv/monitor/bin/python3 -m flask run`
